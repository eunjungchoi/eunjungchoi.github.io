---
title: "쿼리가 복잡할 땐 CTE를 사용하자"
date: 2020-10-25 08:54:28 -0400
categories: 
---

<h4>가능하면 서브쿼리 대신 공통 테이블 표현식을 사용하자</h4>

함수를 사용할 때 생기는 단점 중 하나는 최종 SQL 문에서 이 함수가 어떤 기능을 수행하는지 알 수 없다는 것이다. 
또 다른 누군가가 실수로 함수를 수정해서 해당 함수를 사용하는 쿼리가 작동하지 않을 수도 있다.

이런 문제를 해결하는 더 나은 방법이 있는데 바로 <strong>공통 테이블 표현식(CTE, common table expression) </strong>을 사용하는 것이다. 
물론 데이터베이스 시스템이 이 기능을 지원할 때만 적용된다.
CTE를 사용하면 코드 양이 적고 간략해진다. 별도로 만든 함수를 찾아보지 않고도 CTE 가 반환하는 결과를 쉽게 파악할 수 있다.

또 CTE를 여러 개 만들어 한 CTE 내에서 다른 CTE를 참조할 수 있다. 
CTE의 가장 큰 장점은 일반적으로 사용하는 중첩된 서브쿼리 대신 맨 위에서 맨 아래까지 순차적으로 서브쿼리를 읽는 방식으로 복잡한 쿼리를 작성할 수 있다는 것이다. 
특히 보고서용 자료를 뽑는 쿼리와 다른 그룹에 대한 집계를 수행하는 쿼리를 작성할 때 유용하다. CTE의 또 다른 장점은 한 쿼리 문 내의 여러 곳에서 CTE를 재사용할 수 있다는 것이다.

뷰를 여러 개 만들고 이들을 조인해서 문제를 해결하는 방법도 생각해볼 수 있다. 하지만 이 방법은 관리하기가 무척 어렵다는 단점이 있다. 
누군가가 각 뷰의 정의 내용을 조사해 최종 쿼리에서 종합한 후 사용해야 하고, 직접적으로 유용하지 않은 여러 뷰가 양산되는 문제를 처리해야 하기 때문이다. CTE를 사용하면 뷰를 정의하는 부분에서 비공개 뷰를 생성할 수 있어 한곳에서 뷰를 관리할 수 있다.

<hr>

참고. sql 코딩의 기술, 존 비아시에스 외, 253쪽
